generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Enterprise {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String     @db.VarChar(100)
  description String
  created_at  DateTime   @default(now())

  sectors      Sector[]
  users        User[]
  tasks        Task[]
  projects     Project[]
  requests     EnterpriseRequest[]
}

model Sector {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String     @db.VarChar(100)
  enterprise_id String     @db.Uuid
  enterprise    Enterprise @relation(fields: [enterprise_id], references: [id], onDelete: Cascade)
  sub_sectors   SubSector[]
}

model SubSector {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String     @db.VarChar(100)
  sector_id     String     @db.Uuid
  sector        Sector     @relation(fields: [sector_id], references: [id], onDelete: Cascade)

  users         User[]
  task_links    TaskSubSector[]
  project_links ProjectSubSector[]
}

model User {
  id             String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name           String      @db.VarChar(100)
  password       String      @db.VarChar(100)
  email          String      @unique @db.VarChar(100)
  type           String?     @db.VarChar(10)
  enterprise_id  String?     @db.Uuid
  sub_sector_id  String?     @db.Uuid
  created_at     DateTime    @default(now())
  updated_at     DateTime?

  enterprise     Enterprise? @relation(fields: [enterprise_id], references: [id], onDelete: SetNull)
  sub_sector     SubSector?  @relation(fields: [sub_sector_id], references: [id], onDelete: SetNull)

  task_members   TaskMember[]
  project_members ProjectMember[]
  logs           Log[]
  requests       EnterpriseRequest[]
}

model Task {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title          String           @db.VarChar(255)
  description    String
  status         String           @db.VarChar(50)
  enterprise_id  String?          @db.Uuid
  created_at     DateTime         @default(now())
  updated_at     DateTime?
  finished_at    DateTime?

  enterprise     Enterprise?      @relation(fields: [enterprise_id], references: [id], onDelete: SetNull)
  members        TaskMember[]
  sub_sector_links TaskSubSector[]
  project_links  ProjectTask[]
}

model TaskSubSector {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  task_id       String     @db.Uuid
  sub_sector_id String     @db.Uuid

  task          Task       @relation(fields: [task_id], references: [id], onDelete: Cascade)
  sub_sector    SubSector  @relation(fields: [sub_sector_id], references: [id], onDelete: Cascade)

  @@unique([task_id, sub_sector_id])
}

model TaskMember {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  task_id   String   @db.Uuid
  user_id   String   @db.Uuid

  task      Task     @relation(fields: [task_id], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([task_id, user_id])
}

model Log {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String?   @db.Uuid
  action     String    @db.VarChar(100)
  entity     String    @db.VarChar(50)
  entity_id  String?
  new_value  String?
  created_at DateTime  @default(now())

  user       User?     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, action])
}

model Project {
  id             String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name           String
  description    String
  status         String            @db.VarChar(30)
  enterprise_id  String?           @db.Uuid
  created_at     DateTime          @default(now())
  updated_at     DateTime?

  enterprise     Enterprise?       @relation(fields: [enterprise_id], references: [id], onDelete: SetNull)
  sub_sector_links ProjectSubSector[]
  members        ProjectMember[]
  tasks          ProjectTask[]
}

model ProjectSubSector {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  project_id    String     @db.Uuid
  sub_sector_id String     @db.Uuid

  project       Project    @relation(fields: [project_id], references: [id], onDelete: Cascade)
  sub_sector    SubSector  @relation(fields: [sub_sector_id], references: [id], onDelete: Cascade)

  @@unique([project_id, sub_sector_id])
}

model ProjectMember {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  project_id String   @db.Uuid
  user_id    String   @db.Uuid

  project    Project  @relation(fields: [project_id], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([project_id, user_id])
}

model ProjectTask {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  project_id String   @db.Uuid
  task_id    String   @db.Uuid

  project    Project  @relation(fields: [project_id], references: [id], onDelete: Cascade)
  task       Task     @relation(fields: [task_id], references: [id], onDelete: Cascade)

  @@unique([project_id, task_id])
}

model EnterpriseRequest {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  message       String?    @db.VarChar(255)
  status        String     @db.VarChar(50)
  type          String     @db.VarChar(50)
  user_id       String     @db.Uuid
  enterprise_id String     @db.Uuid
  created_at    DateTime   @default(now())
  updated_at    DateTime   @default(now())

  user          User       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  enterprise    Enterprise @relation(fields: [enterprise_id], references: [id], onDelete: Cascade)
}